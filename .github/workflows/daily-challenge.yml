name: Daily LeetCode Challenge

on:
  schedule:
    # Run at 00:30 UTC every day (08:30 Beijing time)
    # Scheduled after nightly build to avoid conflicts
    - cron: '30 0 * * *'
  workflow_dispatch:
    inputs:
      problem_id:
        description: 'Problem ID to solve (optional)'
        required: false
        default: ''

# Prevent concurrent runs
concurrency:
  group: daily-challenge
  cancel-in-progress: false

jobs:
  solve:
    name: Solve Daily Challenge
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential ccache ninja-build
      
      - name: Set up Python virtual environment
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run AI solver
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_USE_REASONER: ${{ secrets.DEEPSEEK_USE_REASONER || 'true' }}
        run: |
          source venv/bin/activate
          if [ -n "${{ github.event.inputs.problem_id }}" ]; then
            python -m script.leetcode.ai.solver ${{ github.event.inputs.problem_id }}
          else
            python -m script.leetcode.ai.solver
          fi
        continue-on-error: true
      
      - name: Get problem info
        id: get_info
        run: |
          REPORT_FILE=$(ls SOLUTION_REPORT_*.md 2>/dev/null | head -1)
          PROBLEM_ID=$(echo ${REPORT_FILE#SOLUTION_REPORT_} | sed 's/\.md$//')
          
          echo "problem_id=${PROBLEM_ID:-}" >> $GITHUB_OUTPUT
          echo "report_file=${REPORT_FILE:-}" >> $GITHUB_OUTPUT
          echo "has_solution=false" >> $GITHUB_OUTPUT
          
          [ -z "$REPORT_FILE" ] && echo "No solution report found" && exit 0
          
          echo "Found report: $REPORT_FILE (ID: $PROBLEM_ID)"
          
          SOURCE_FILE=$(git status --porcelain | grep '^??' | grep 'src/leetcode/problems/.*\.cpp$' | awk '{print $2}' | head -1)
          HEADER_FILE=$(git status --porcelain | grep '^??' | grep 'include/leetcode/problems/.*\.h$' | awk '{print $2}' | head -1)
          TEST_FILE=$(git status --porcelain | grep '^??' | grep 'test/leetcode/problems/.*\.cpp$' | awk '{print $2}' | head -1)
          
          if [ -n "$SOURCE_FILE" ] && [ -n "$HEADER_FILE" ] && [ -n "$TEST_FILE" ]; then
            PROBLEM_SLUG=$(basename "$SOURCE_FILE" .cpp)
            echo "problem_slug=$PROBLEM_SLUG" >> $GITHUB_OUTPUT
            echo "has_solution=true" >> $GITHUB_OUTPUT
            echo "source_file=$SOURCE_FILE" >> $GITHUB_OUTPUT
            echo "header_file=$HEADER_FILE" >> $GITHUB_OUTPUT
            echo "test_file=$TEST_FILE" >> $GITHUB_OUTPUT
          else
            echo "Incomplete files generated"
          fi
      
      - name: Build and test solution
        if: steps.get_info.outputs.has_solution == 'true'
        run: |
          PROBLEM_SLUG="${{ steps.get_info.outputs.problem_slug }}"
          echo "Building and testing: $PROBLEM_SLUG"
          
          mkdir -p build && cd build
          cmake .. -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DLEETCODE_SINGLE_PROBLEM="$PROBLEM_SLUG"
          cmake --build . -j
          ./bin/single_problem_test
      
      - name: Upload artifacts
        if: steps.get_info.outputs.report_file != ''
        uses: actions/upload-artifact@v4
        with:
          name: solution-problem-${{ steps.get_info.outputs.problem_id }}
          path: |
            ${{ steps.get_info.outputs.report_file }}
            ${{ steps.get_info.outputs.source_file }}
            ${{ steps.get_info.outputs.header_file }}
            ${{ steps.get_info.outputs.test_file }}
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Create Pull Request
        if: steps.get_info.outputs.has_solution == 'true' && success()
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "feat: Add solution for LeetCode #${{ steps.get_info.outputs.problem_id }}"
          title: "ðŸ¤– Daily Challenge: Problem #${{ steps.get_info.outputs.problem_id }}"
          body-path: ${{ steps.get_info.outputs.report_file }}
          branch: daily-challenge/${{ steps.get_info.outputs.problem_id }}
          base: main
          labels: |
            daily-challenge
            ai-generated
          draft: false
          delete-branch: true

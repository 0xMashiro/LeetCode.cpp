name: Daily LeetCode Challenge

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 0:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 8:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  solve-daily-challenge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential ccache ninja-build just
      
      - name: Set up Python virtual environment
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run AI solver
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_USE_REASONER: ${{ secrets.DEEPSEEK_USE_REASONER || 'true' }}
        run: |
          source venv/bin/activate
          python script/leetcode/ai_solver.py
        continue-on-error: true  # å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­ï¼Œä»¥ä¾¿åˆ›å»º PR æŠ¥å‘Šé—®é¢˜
      
      - name: Get problem ID and files
        id: get_files
        run: |
          # æŸ¥æ‰¾è§£é¢˜æŠ¥å‘Šå¹¶æå– problem_id
          REPORT_FILE=$(ls SOLUTION_REPORT_*.md 2>/dev/null | head -1)
          PROBLEM_ID=$(echo ${REPORT_FILE#SOLUTION_REPORT_} | sed 's/\.md$//')
          
          # è®¾ç½®é»˜è®¤è¾“å‡º
          echo "problem_id=${PROBLEM_ID:-}" >> $GITHUB_OUTPUT
          echo "report_file=${REPORT_FILE:-}" >> $GITHUB_OUTPUT
          echo "skip_pr=false" >> $GITHUB_OUTPUT
          echo "has_solution=false" >> $GITHUB_OUTPUT
          
          # å¦‚æœæ²¡æœ‰æŠ¥å‘Šæ–‡ä»¶ï¼Œç›´æ¥é€€å‡º
          [ -z "$REPORT_FILE" ] && echo "âœ— æœªæ‰¾åˆ°è§£é¢˜æŠ¥å‘Š" && exit 0
          
          echo "âœ“ æ‰¾åˆ°æŠ¥å‘Š: $REPORT_FILE (ID: $PROBLEM_ID)"
          
          # æ£€æŸ¥ SKIP_PR æ ‡è®°
          if [ -f "SKIP_PR" ]; then
            echo "skip_pr=true" >> $GITHUB_OUTPUT
            {
              echo "skip_reason<<EOF"
              cat SKIP_PR
              echo "EOF"
            } >> $GITHUB_OUTPUT
            echo "âš ï¸  è·³è¿‡ PR: $(cat SKIP_PR)"
            exit 0
          fi
          
          # ä½¿ç”¨ git æŸ¥æ‰¾æ–°ç”Ÿæˆçš„ä»£ç æ–‡ä»¶
          SOURCE_FILE=$(git status --porcelain | grep '^??' | grep 'src/leetcode/problems/.*\.cpp$' | awk '{print $2}' | head -1)
          HEADER_FILE=$(git status --porcelain | grep '^??' | grep 'include/leetcode/problems/.*\.h$' | awk '{print $2}' | head -1)
          TEST_FILE=$(git status --porcelain | grep '^??' | grep 'test/leetcode/problems/.*\.cpp$' | awk '{print $2}' | head -1)
          
          # æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -n "$SOURCE_FILE" ] && [ -n "$HEADER_FILE" ] && [ -n "$TEST_FILE" ]; then
            echo "has_solution=true" >> $GITHUB_OUTPUT
            echo "source_file=$SOURCE_FILE" >> $GITHUB_OUTPUT
            echo "header_file=$HEADER_FILE" >> $GITHUB_OUTPUT
            echo "test_file=$TEST_FILE" >> $GITHUB_OUTPUT
            echo "âœ“ æ‰¾åˆ°æ‰€æœ‰æ–‡ä»¶ï¼Œå°†åˆ›å»º PR"
          else
            echo "âœ— æ–‡ä»¶ä¸å®Œæ•´ (SOURCE: ${SOURCE_FILE:-æœªæ‰¾åˆ°}, HEADER: ${HEADER_FILE:-æœªæ‰¾åˆ°}, TEST: ${TEST_FILE:-æœªæ‰¾åˆ°})"
          fi
      
      - name: Log skip reason
        if: steps.get_files.outputs.skip_pr == 'true'
        run: |
          echo "â­ï¸  è·³è¿‡ PR åˆ›å»º"
          echo "åŸå› : ${{ steps.get_files.outputs.skip_reason }}"
      
      - name: Upload artifacts
        if: steps.get_files.outputs.report_file != ''
        uses: actions/upload-artifact@v4
        with:
          name: solution-files-problem-${{ steps.get_files.outputs.problem_id }}
          path: |
            ${{ steps.get_files.outputs.report_file }}
            ${{ steps.get_files.outputs.source_file }}
            ${{ steps.get_files.outputs.header_file }}
            ${{ steps.get_files.outputs.test_file }}
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Create Pull Request
        if: steps.get_files.outputs.has_solution == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "feat: Solve LeetCode Daily Challenge #${{ steps.get_files.outputs.problem_id }}"
          title: "ğŸ¤– Daily Challenge: Problem #${{ steps.get_files.outputs.problem_id }}"
          body-path: ${{ steps.get_files.outputs.report_file }}
          branch: daily-challenge-${{ steps.get_files.outputs.problem_id }}-${{ github.run_id }}
          base: main
          labels: |
            daily-challenge
            ai-generated
          draft: false
          delete-branch: true
